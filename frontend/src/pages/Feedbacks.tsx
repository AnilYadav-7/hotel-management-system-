import React, { useState, useEffect } from 'react';
import {
  Box,
  Typography,
  Button,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  Rating,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
  IconButton,
  Alert,
  Chip,
  Grid,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  CircularProgress,
  Tooltip,
  Card,
  CardContent
} from '@mui/material';\nimport {\n  Add,\n  Edit,\n  Delete,\n  Search,\n  Star,\n  Feedback\n} from '@mui/icons-material';\nimport { feedbacksAPI, GuestFeedbackDTO } from '../services/api';\n\nconst Feedbacks: React.FC = () => {\n  const [feedbacks, setFeedbacks] = useState<GuestFeedbackDTO[]>([]);\n  const [openDialog, setOpenDialog] = useState(false);\n  const [editingFeedback, setEditingFeedback] = useState<GuestFeedbackDTO | null>(null);\n  const [loading, setLoading] = useState(false);\n  const [searchFilters, setSearchFilters] = useState({\n    name: '',\n    minRating: 0,\n    maxRating: 5\n  });\n  const [formData, setFormData] = useState<GuestFeedbackDTO>({\n    guestName: '',\n    guestEmail: '',\n    roomNumber: '',\n    rating: 5,\n    serviceQuality: '',\n    roomCleanliness: '',\n    amenitiesFeedback: '',\n    overallExperience: '',\n    suggestions: ''\n  });\n  const [error, setError] = useState('');\n  const [success, setSuccess] = useState('');\n\n  useEffect(() => {\n    fetchFeedbacks();\n  }, []);\n\n  const fetchFeedbacks = async () => {\n    setLoading(true);\n    try {\n      const response = await feedbacksAPI.getAllFeedbacks(0, 100);\n      setFeedbacks(response.data as GuestFeedbackDTO[]);\n    } catch (err) {\n      setError('Failed to fetch feedbacks');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleSearch = async () => {\n    setLoading(true);\n    try {\n      const response = await feedbacksAPI.searchAndFilterFeedbacks(searchFilters);\n      setFeedbacks(response.data as GuestFeedbackDTO[]);\n    } catch (err) {\n      setError('Search failed');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleOpenDialog = (feedback?: GuestFeedbackDTO) => {\n    if (feedback) {\n      setEditingFeedback(feedback);\n      setFormData(feedback);\n    } else {\n      setEditingFeedback(null);\n      setFormData({\n        guestName: '',\n        guestEmail: '',\n        roomNumber: '',\n        rating: 5,\n        serviceQuality: '',\n        roomCleanliness: '',\n        amenitiesFeedback: '',\n        overallExperience: '',\n        suggestions: ''\n      });\n    }\n    setOpenDialog(true);\n    setError('');\n  };\n\n  const handleCloseDialog = () => {\n    setOpenDialog(false);\n    setEditingFeedback(null);\n    setError('');\n  };\n\n  const validateForm = (): boolean => {\n    if (!formData.guestName || !formData.guestEmail || !formData.serviceQuality || !formData.roomCleanliness || !formData.amenitiesFeedback || !formData.overallExperience) {\n      setError('All required fields must be filled');\n      return false;\n    }\n    if (!/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(formData.guestEmail)) {\n      setError('Invalid email format');\n      return false;\n    }\n    return true;\n  };\n\n  const handleSubmit = async () => {\n    if (!validateForm()) return;\n\n    try {\n      if (editingFeedback) {\n        await feedbacksAPI.updateFeedback(editingFeedback.feedbackId!, formData);\n        setSuccess('Feedback updated successfully');\n      } else {\n        await feedbacksAPI.submitFeedback(formData);\n        setSuccess('Feedback submitted successfully');\n      }\n      fetchFeedbacks();\n      handleCloseDialog();\n    } catch (err: any) {\n      setError(err.response?.data?.message || 'Operation failed');\n    }\n  };\n\n  const handleDelete = async (id: number) => {\n    if (window.confirm('Are you sure you want to delete this feedback?')) {\n      try {\n        await feedbacksAPI.deleteFeedback(id);\n        setSuccess('Feedback deleted successfully');\n        fetchFeedbacks();\n      } catch (err: any) {\n        setError(err.response?.data?.message || 'Delete failed');\n      }\n    }\n  };\n\n  const getRatingColor = (rating: number) => {\n    if (rating >= 4.5) return 'success';\n    if (rating >= 3.5) return 'warning';\n    return 'error';\n  };\n\n  const avgRating = feedbacks.length > 0 \n    ? (feedbacks.reduce((sum, f) => sum + f.rating, 0) / feedbacks.length).toFixed(1)\n    : 0;\n\n  return (\n    <Box sx={{ p: 3 }}>\n      <Box display=\"flex\" justifyContent=\"space-between\" alignItems=\"center\" mb={3}>\n        <Box>\n          <Typography variant=\"h4\" fontWeight=\"bold\">Guest Feedbacks</Typography>\n          <Typography variant=\"body2\" color=\"textSecondary\" sx={{ mt: 0.5 }}>\n            Manage and analyze guest feedback\n          </Typography>\n        </Box>\n        <Button\n          variant=\"contained\"\n          startIcon={<Add />}\n          onClick={() => handleOpenDialog()}\n          size=\"large\"\n          sx={{ textTransform: 'none', fontWeight: 600 }}\n        >\n          Add Feedback\n        </Button>\n      </Box>\n\n      {error && <Alert severity=\"error\" sx={{ mb: 2 }} onClose={() => setError('')}>{error}</Alert>}\n      {success && <Alert severity=\"success\" sx={{ mb: 2 }} onClose={() => setSuccess('')}>{success}</Alert>}\n\n      <Grid container spacing={2} sx={{ mb: 3 }}>\n        <Grid item xs={12} sm={6} md={3}>\n          <Card sx={{ boxShadow: 1 }}>\n            <CardContent>\n              <Typography color=\"textSecondary\" gutterBottom>\n                Total Feedbacks\n              </Typography>\n              <Typography variant=\"h5\" fontWeight=\"bold\">\n                {feedbacks.length}\n              </Typography>\n            </CardContent>\n          </Card>\n        </Grid>\n        <Grid item xs={12} sm={6} md={3}>\n          <Card sx={{ boxShadow: 1 }}>\n            <CardContent>\n              <Typography color=\"textSecondary\" gutterBottom>\n                Average Rating\n              </Typography>\n              <Box display=\"flex\" alignItems=\"center\" gap={1}>\n                <Typography variant=\"h5\" fontWeight=\"bold\">\n                  {avgRating}\n                </Typography>\n                <Star sx={{ color: '#ffc107' }} />\n              </Box>\n            </CardContent>\n          </Card>\n        </Grid>\n      </Grid>\n\n      <Paper sx={{ p: 2, mb: 3, boxShadow: 1 }}>\n        <Typography variant=\"h6\" gutterBottom fontWeight=\"bold\">Search & Filter</Typography>\n        <Grid container spacing={2} alignItems=\"center\">\n          <Grid item xs={12} md={4}>\n            <TextField\n              fullWidth\n              label=\"Guest Name\"\n              value={searchFilters.name}\n              onChange={(e) => setSearchFilters({ ...searchFilters, name: e.target.value })}\n              variant=\"outlined\"\n              size=\"small\"\n            />\n          </Grid>\n          <Grid item xs={12} md={3}>\n            <FormControl fullWidth size=\"small\">\n              <InputLabel>Min Rating</InputLabel>\n              <Select\n                value={searchFilters.minRating}\n                onChange={(e) => setSearchFilters({ ...searchFilters, minRating: Number(e.target.value) })}\n                label=\"Min Rating\"\n              >\n                <MenuItem value={0}>All</MenuItem>\n                <MenuItem value={1}>1+</MenuItem>\n                <MenuItem value={2}>2+</MenuItem>\n                <MenuItem value={3}>3+</MenuItem>\n                <MenuItem value={4}>4+</MenuItem>\n                <MenuItem value={5}>5</MenuItem>\n              </Select>\n            </FormControl>\n          </Grid>\n          <Grid item xs={12} md={3}>\n            <FormControl fullWidth size=\"small\">\n              <InputLabel>Max Rating</InputLabel>\n              <Select\n                value={searchFilters.maxRating}\n                onChange={(e) => setSearchFilters({ ...searchFilters, maxRating: Number(e.target.value) })}\n                label=\"Max Rating\"\n              >\n                <MenuItem value={5}>5</MenuItem>\n                <MenuItem value={4}>4-</MenuItem>\n                <MenuItem value={3}>3-</MenuItem>\n                <MenuItem value={2}>2-</MenuItem>\n                <MenuItem value={1}>1-</MenuItem>\n              </Select>\n            </FormControl>\n          </Grid>\n          <Grid item xs={12} md={2}>\n            <Button\n              variant=\"contained\"\n              startIcon={<Search />}\n              onClick={handleSearch}\n              fullWidth\n              sx={{ textTransform: 'none', fontWeight: 600 }}\n            >\n              Search\n            </Button>\n          </Grid>\n        </Grid>\n      </Paper>\n\n      {loading ? (\n        <Box display=\"flex\" justifyContent=\"center\" py={5}>\n          <CircularProgress />\n        </Box>\n      ) : (\n        <TableContainer component={Paper} sx={{ boxShadow: 2 }}>\n          <Table>\n            <TableHead sx={{ backgroundColor: '#f5f5f5' }}>\n              <TableRow>\n                <TableCell sx={{ fontWeight: 'bold' }}>Guest</TableCell>\n                <TableCell sx={{ fontWeight: 'bold' }}>Room</TableCell>\n                <TableCell sx={{ fontWeight: 'bold' }}>Rating</TableCell>\n                <TableCell sx={{ fontWeight: 'bold' }}>Service</TableCell>\n                <TableCell sx={{ fontWeight: 'bold' }}>Cleanliness</TableCell>\n                <TableCell sx={{ fontWeight: 'bold' }}>Date</TableCell>\n                <TableCell sx={{ fontWeight: 'bold', textAlign: 'center' }}>Actions</TableCell>\n              </TableRow>\n            </TableHead>\n            <TableBody>\n              {feedbacks.length === 0 ? (\n                <TableRow>\n                  <TableCell colSpan={7} align=\"center\" sx={{ py: 4 }}>\n                    <Typography color=\"textSecondary\">No feedbacks found</Typography>\n                  </TableCell>\n                </TableRow>\n              ) : (\n                feedbacks.map((feedback) => (\n                  <TableRow key={feedback.feedbackId} hover>\n                    <TableCell>\n                      <Box>\n                        <Typography variant=\"body2\" fontWeight=\"bold\">\n                          {feedback.guestName}\n                        </Typography>\n                        <Typography variant=\"caption\" color=\"textSecondary\">\n                          {feedback.guestEmail}\n                        </Typography>\n                      </Box>\n                    </TableCell>\n                    <TableCell>\n                      <Chip label={feedback.roomNumber || '-'} variant=\"outlined\" size=\"small\" />\n                    </TableCell>\n                    <TableCell>\n                      <Box display=\"flex\" alignItems=\"center\" gap={0.5}>\n                        <Rating value={feedback.rating} readOnly size=\"small\" />\n                        <Typography variant=\"body2\" fontWeight=\"bold\">\n                          {feedback.rating}\n                        </Typography>\n                      </Box>\n                    </TableCell>\n                    <TableCell>\n                      <Typography variant=\"body2\" noWrap sx={{ maxWidth: 150 }}>\n                        {feedback.serviceQuality}\n                      </Typography>\n                    </TableCell>\n                    <TableCell>\n                      <Typography variant=\"body2\" noWrap sx={{ maxWidth: 150 }}>\n                        {feedback.roomCleanliness}\n                      </Typography>\n                    </TableCell>\n                    <TableCell>\n                      <Typography variant=\"body2\">\n                        {feedback.createdAt \n                          ? new Date(feedback.createdAt).toLocaleDateString()\n                          : '-'\n                        }\n                      </Typography>\n                    </TableCell>\n                    <TableCell align=\"center\">\n                      <Tooltip title=\"Edit\">\n                        <IconButton\n                          color=\"primary\"\n                          onClick={() => handleOpenDialog(feedback)}\n                          size=\"small\"\n                        >\n                          <Edit fontSize=\"small\" />\n                        </IconButton>\n                      </Tooltip>\n                      <Tooltip title=\"Delete\">\n                        <IconButton\n                          color=\"error\"\n                          onClick={() => handleDelete(feedback.feedbackId!)}\n                          size=\"small\"\n                        >\n                          <Delete fontSize=\"small\" />\n                        </IconButton>\n                      </Tooltip>\n                    </TableCell>\n                  </TableRow>\n                ))\n              )}\n            </TableBody>\n          </Table>\n        </TableContainer>\n      )}\n\n      <Dialog open={openDialog} onClose={handleCloseDialog} maxWidth=\"md\" fullWidth>\n        <DialogTitle sx={{ fontWeight: 'bold', fontSize: '1.3rem' }}>\n          {editingFeedback ? 'Edit Feedback' : 'Submit New Feedback'}\n        </DialogTitle>\n        <DialogContent>\n          <Box sx={{ pt: 2 }}>\n            <Grid container spacing={2}>\n              <Grid item xs={12} md={6}>\n                <TextField\n                  fullWidth\n                  label=\"Guest Name\"\n                  value={formData.guestName}\n                  onChange={(e) => setFormData({ ...formData, guestName: e.target.value })}\n                  required\n                  variant=\"outlined\"\n                />\n              </Grid>\n              <Grid item xs={12} md={6}>\n                <TextField\n                  fullWidth\n                  label=\"Guest Email\"\n                  type=\"email\"\n                  value={formData.guestEmail}\n                  onChange={(e) => setFormData({ ...formData, guestEmail: e.target.value })}\n                  required\n                  variant=\"outlined\"\n                />\n              </Grid>\n              <Grid item xs={12} md={6}>\n                <TextField\n                  fullWidth\n                  label=\"Room Number\"\n                  value={formData.roomNumber}\n                  onChange={(e) => setFormData({ ...formData, roomNumber: e.target.value })}\n                  variant=\"outlined\"\n                />\n              </Grid>\n              <Grid item xs={12} md={6}>\n                <Box sx={{ pt: 1 }}>\n                  <Typography component=\"legend\" variant=\"body2\" fontWeight=\"bold\">Rating</Typography>\n                  <Rating\n                    value={formData.rating}\n                    onChange={(_, newValue) => {\n                      setFormData({ ...formData, rating: newValue || 5 });\n                    }}\n                  />\n                </Box>\n              </Grid>\n              <Grid item xs={12}>\n                <TextField\n                  fullWidth\n                  label=\"Service Quality Feedback\"\n                  multiline\n                  rows={2}\n                  value={formData.serviceQuality}\n                  onChange={(e) => setFormData({ ...formData, serviceQuality: e.target.value })}\n                  required\n                  variant=\"outlined\"\n                />\n              </Grid>\n              <Grid item xs={12}>\n                <TextField\n                  fullWidth\n                  label=\"Room Cleanliness Feedback\"\n                  multiline\n                  rows={2}\n                  value={formData.roomCleanliness}\n                  onChange={(e) => setFormData({ ...formData, roomCleanliness: e.target.value })}\n                  required\n                  variant=\"outlined\"\n                />\n              </Grid>\n              <Grid item xs={12}>\n                <TextField\n                  fullWidth\n                  label=\"Amenities Feedback\"\n                  multiline\n                  rows={2}\n                  value={formData.amenitiesFeedback}\n                  onChange={(e) => setFormData({ ...formData, amenitiesFeedback: e.target.value })}\n                  required\n                  variant=\"outlined\"\n                />\n              </Grid>\n              <Grid item xs={12}>\n                <TextField\n                  fullWidth\n                  label=\"Overall Experience\"\n                  multiline\n                  rows={2}\n                  value={formData.overallExperience}\n                  onChange={(e) => setFormData({ ...formData, overallExperience: e.target.value })}\n                  required\n                  variant=\"outlined\"\n                />\n              </Grid>\n              <Grid item xs={12}>\n                <TextField\n                  fullWidth\n                  label=\"Suggestions (Optional)\"\n                  multiline\n                  rows={2}\n                  value={formData.suggestions}\n                  onChange={(e) => setFormData({ ...formData, suggestions: e.target.value })}\n                  variant=\"outlined\"\n                />\n              </Grid>\n            </Grid>\n          </Box>\n        </DialogContent>\n        <DialogActions sx={{ p: 2 }}>\n          <Button onClick={handleCloseDialog}>Cancel</Button>\n          <Button onClick={handleSubmit} variant=\"contained\" sx={{ textTransform: 'none', fontWeight: 600 }}>\n            {editingFeedback ? 'Update' : 'Submit'}\n          </Button>\n        </DialogActions>\n      </Dialog>\n    </Box>\n  );\n};\n\nexport default Feedbacks;
