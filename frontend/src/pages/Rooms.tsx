import React, { useState, useEffect } from 'react';
import {
  Box,
  Typography,
  Button,
  Grid,
  Card,
  CardContent,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  Chip,
  IconButton,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
  Alert,
  CircularProgress,
  Tooltip
} from '@mui/material';\nimport {\n  Add,\n  Edit,\n  Delete,\n  MeetingRoom,\n  DoneAll,\n  BuildCircle\n} from '@mui/icons-material';\nimport { roomsAPI, RoomType, RoomStatus, RoomRequest, RoomResponse } from '../services/api';\n\nconst Rooms: React.FC = () => {\n  const [rooms, setRooms] = useState<RoomResponse[]>([]);\n  const [openDialog, setOpenDialog] = useState(false);\n  const [editingRoom, setEditingRoom] = useState<RoomResponse | null>(null);\n  const [loading, setLoading] = useState(false);\n  const [formData, setFormData] = useState<RoomRequest>({\n    roomNumber: '',\n    roomType: RoomType.SINGLE,\n    price: 0\n  });\n  const [error, setError] = useState('');\n  const [success, setSuccess] = useState('');\n\n  useEffect(() => {\n    fetchRooms();\n  }, []);\n\n  const fetchRooms = async () => {\n    setLoading(true);\n    try {\n      const data = await roomsAPI.getAllRooms(0, 100);\n      setRooms(data);\n    } catch (err) {\n      setError('Failed to fetch rooms');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleOpenDialog = (room?: RoomResponse) => {\n    if (room) {\n      setEditingRoom(room);\n      setFormData({\n        roomNumber: room.roomNumber,\n        roomType: room.roomType,\n        price: room.price\n      });\n    } else {\n      setEditingRoom(null);\n      setFormData({\n        roomNumber: '',\n        roomType: RoomType.SINGLE,\n        price: 0\n      });\n    }\n    setOpenDialog(true);\n    setError('');\n  };\n\n  const handleCloseDialog = () => {\n    setOpenDialog(false);\n    setEditingRoom(null);\n    setError('');\n  };\n\n  const handleSubmit = async () => {\n    if (!formData.roomNumber || !formData.roomType || formData.price <= 0) {\n      setError('All fields are required and price must be greater than 0');\n      return;\n    }\n\n    try {\n      if (editingRoom) {\n        await roomsAPI.updateRoom(editingRoom.id, formData);\n        setSuccess('Room updated successfully');\n      } else {\n        await roomsAPI.createRoom(formData);\n        setSuccess('Room created successfully');\n      }\n      fetchRooms();\n      handleCloseDialog();\n    } catch (err: any) {\n      setError(err.response?.data?.message || 'Operation failed');\n    }\n  };\n\n  const handleDelete = async (id: number, roomNumber: string) => {\n    if (window.confirm(`Are you sure you want to delete Room ${roomNumber}?`)) {\n      try {\n        await roomsAPI.deleteRoom(id);\n        setSuccess('Room deleted successfully');\n        fetchRooms();\n      } catch (err: any) {\n        setError(err.response?.data?.message || 'Delete failed');\n      }\n    }\n  };\n\n  const getStatusColor = (status: RoomStatus) => {\n    switch (status) {\n      case RoomStatus.AVAILABLE:\n        return 'success';\n      case RoomStatus.BOOKED:\n        return 'warning';\n      case RoomStatus.MAINTENANCE:\n        return 'error';\n      default:\n        return 'default';\n    }\n  };\n\n  const getStatusIcon = (status: RoomStatus) => {\n    switch (status) {\n      case RoomStatus.AVAILABLE:\n        return <DoneAll fontSize=\"small\" />;\n      case RoomStatus.BOOKED:\n        return <MeetingRoom fontSize=\"small\" />;\n      case RoomStatus.MAINTENANCE:\n        return <BuildCircle fontSize=\"small\" />;\n      default:\n        return null;\n    }\n  };\n\n  const stats = {\n    total: rooms.length,\n    available: rooms.filter(r => r.status === RoomStatus.AVAILABLE).length,\n    booked: rooms.filter(r => r.status === RoomStatus.BOOKED).length,\n    maintenance: rooms.filter(r => r.status === RoomStatus.MAINTENANCE).length\n  };\n\n  return (\n    <Box sx={{ p: 3 }}>\n      <Box display=\"flex\" justifyContent=\"space-between\" alignItems=\"center\" mb={3}>\n        <Box>\n          <Typography variant=\"h4\" fontWeight=\"bold\">Rooms Management</Typography>\n          <Typography variant=\"body2\" color=\"textSecondary\" sx={{ mt: 0.5 }}>\n            Manage hotel rooms and availability\n          </Typography>\n        </Box>\n        <Button\n          variant=\"contained\"\n          startIcon={<Add />}\n          onClick={() => handleOpenDialog()}\n          size=\"large\"\n          sx={{ textTransform: 'none', fontWeight: 600 }}\n        >\n          Add Room\n        </Button>\n      </Box>\n\n      {error && <Alert severity=\"error\" sx={{ mb: 2 }} onClose={() => setError('')}>{error}</Alert>}\n      {success && <Alert severity=\"success\" sx={{ mb: 2 }} onClose={() => setSuccess('')}>{success}</Alert>}\n\n      <Grid container spacing={2} sx={{ mb: 3 }}>\n        <Grid item xs={12} sm={6} md={3}>\n          <Card sx={{ boxShadow: 1 }}>\n            <CardContent>\n              <Typography color=\"textSecondary\" gutterBottom>\n                Total Rooms\n              </Typography>\n              <Typography variant=\"h5\" fontWeight=\"bold\">\n                {stats.total}\n              </Typography>\n            </CardContent>\n          </Card>\n        </Grid>\n        <Grid item xs={12} sm={6} md={3}>\n          <Card sx={{ boxShadow: 1 }}>\n            <CardContent>\n              <Typography color=\"textSecondary\" gutterBottom>\n                Available\n              </Typography>\n              <Typography variant=\"h5\" fontWeight=\"bold\" sx={{ color: '#4caf50' }}>\n                {stats.available}\n              </Typography>\n            </CardContent>\n          </Card>\n        </Grid>\n        <Grid item xs={12} sm={6} md={3}>\n          <Card sx={{ boxShadow: 1 }}>\n            <CardContent>\n              <Typography color=\"textSecondary\" gutterBottom>\n                Booked\n              </Typography>\n              <Typography variant=\"h5\" fontWeight=\"bold\" sx={{ color: '#ff9800' }}>\n                {stats.booked}\n              </Typography>\n            </CardContent>\n          </Card>\n        </Grid>\n        <Grid item xs={12} sm={6} md={3}>\n          <Card sx={{ boxShadow: 1 }}>\n            <CardContent>\n              <Typography color=\"textSecondary\" gutterBottom>\n                Maintenance\n              </Typography>\n              <Typography variant=\"h5\" fontWeight=\"bold\" sx={{ color: '#f44336' }}>\n                {stats.maintenance}\n              </Typography>\n            </CardContent>\n          </Card>\n        </Grid>\n      </Grid>\n\n      {loading ? (\n        <Box display=\"flex\" justifyContent=\"center\" py={5}>\n          <CircularProgress />\n        </Box>\n      ) : (\n        <TableContainer component={Paper} sx={{ boxShadow: 2 }}>\n          <Table>\n            <TableHead sx={{ backgroundColor: '#f5f5f5' }}>\n              <TableRow>\n                <TableCell sx={{ fontWeight: 'bold' }}>Room Number</TableCell>\n                <TableCell sx={{ fontWeight: 'bold' }}>Type</TableCell>\n                <TableCell sx={{ fontWeight: 'bold' }}>Price/Night</TableCell>\n                <TableCell sx={{ fontWeight: 'bold' }}>Status</TableCell>\n                <TableCell sx={{ fontWeight: 'bold', textAlign: 'center' }}>Actions</TableCell>\n              </TableRow>\n            </TableHead>\n            <TableBody>\n              {rooms.length === 0 ? (\n                <TableRow>\n                  <TableCell colSpan={5} align=\"center\" sx={{ py: 4 }}>\n                    <Typography color=\"textSecondary\">No rooms found</Typography>\n                  </TableCell>\n                </TableRow>\n              ) : (\n                rooms.map((room) => (\n                  <TableRow key={room.id} hover>\n                    <TableCell sx={{ fontWeight: 600 }}>{room.roomNumber}</TableCell>\n                    <TableCell>\n                      <Chip label={room.roomType} variant=\"outlined\" size=\"small\" />\n                    </TableCell>\n                    <TableCell sx={{ fontWeight: 500 }}>${room.price.toFixed(2)}</TableCell>\n                    <TableCell>\n                      <Chip\n                        label={room.status}\n                        color={getStatusColor(room.status) as any}\n                        icon={getStatusIcon(room.status)}\n                        size=\"small\"\n                      />\n                    </TableCell>\n                    <TableCell align=\"center\">\n                      <Tooltip title=\"Edit\">\n                        <IconButton\n                          color=\"primary\"\n                          onClick={() => handleOpenDialog(room)}\n                          size=\"small\"\n                        >\n                          <Edit fontSize=\"small\" />\n                        </IconButton>\n                      </Tooltip>\n                      <Tooltip title=\"Delete\">\n                        <IconButton\n                          color=\"error\"\n                          onClick={() => handleDelete(room.id, room.roomNumber)}\n                          size=\"small\"\n                        >\n                          <Delete fontSize=\"small\" />\n                        </IconButton>\n                      </Tooltip>\n                    </TableCell>\n                  </TableRow>\n                ))\n              )}\n            </TableBody>\n          </Table>\n        </TableContainer>\n      )}\n\n      <Dialog open={openDialog} onClose={handleCloseDialog} maxWidth=\"sm\" fullWidth>\n        <DialogTitle sx={{ fontWeight: 'bold', fontSize: '1.3rem' }}>\n          {editingRoom ? 'Edit Room' : 'Add New Room'}\n        </DialogTitle>\n        <DialogContent>\n          <Box sx={{ pt: 2 }}>\n            <TextField\n              fullWidth\n              label=\"Room Number\"\n              value={formData.roomNumber}\n              onChange={(e) => setFormData({ ...formData, roomNumber: e.target.value })}\n              margin=\"normal\"\n              required\n              variant=\"outlined\"\n            />\n            <FormControl fullWidth margin=\"normal\" required>\n              <InputLabel>Room Type</InputLabel>\n              <Select\n                value={formData.roomType}\n                onChange={(e) => setFormData({ ...formData, roomType: e.target.value as RoomType })}\n                label=\"Room Type\"\n              >\n                <MenuItem value={RoomType.SINGLE}>Single</MenuItem>\n                <MenuItem value={RoomType.DOUBLE}>Double</MenuItem>\n                <MenuItem value={RoomType.SUITE}>Suite</MenuItem>\n                <MenuItem value={RoomType.DELUXE}>Deluxe</MenuItem>\n              </Select>\n            </FormControl>\n            <TextField\n              fullWidth\n              label=\"Price per Night\"\n              type=\"number\"\n              value={formData.price}\n              onChange={(e) => setFormData({ ...formData, price: parseFloat(e.target.value) || 0 })}\n              margin=\"normal\"\n              required\n              variant=\"outlined\"\n              inputProps={{ min: 0, step: 0.01 }}\n            />\n          </Box>\n        </DialogContent>\n        <DialogActions sx={{ p: 2 }}>\n          <Button onClick={handleCloseDialog}>Cancel</Button>\n          <Button onClick={handleSubmit} variant=\"contained\" sx={{ textTransform: 'none', fontWeight: 600 }}>\n            {editingRoom ? 'Update' : 'Create'}\n          </Button>\n        </DialogActions>\n      </Dialog>\n    </Box>\n  );\n};\n\nexport default Rooms;
