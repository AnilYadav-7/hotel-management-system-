import React, { useState, useEffect } from 'react';
import {
  Box,
  Typography,
  Button,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
  IconButton,
  Alert,
  Chip,
  Grid,
  CircularProgress,
  Tooltip,
  TablePagination
} from '@mui/material';\nimport {\n  Add,\n  Edit,\n  Delete,\n  CheckCircle,\n  LogoutOutlined,\n  CancelOutlined,\n  Info\n} from '@mui/icons-material';\nimport { bookingsAPI, roomsAPI, guestsAPI, BookingStatus, BookingRequest, BookingResponse, RoomResponse, GuestResponse } from '../services/api';\n\nconst Bookings: React.FC = () => {\n  const [bookings, setBookings] = useState<BookingResponse[]>([]);\n  const [rooms, setRooms] = useState<RoomResponse[]>([]);\n  const [guests, setGuests] = useState<GuestResponse[]>([]);\n  const [openDialog, setOpenDialog] = useState(false);\n  const [editingBooking, setEditingBooking] = useState<BookingResponse | null>(null);\n  const [loading, setLoading] = useState(false);\n  const [page, setPage] = useState(0);\n  const [rowsPerPage, setRowsPerPage] = useState(10);\n  const [formData, setFormData] = useState<BookingRequest>({\n    guestId: 0,\n    roomId: 0,\n    checkInDate: '',\n    checkOutDate: '',\n    numberOfAdults: 1,\n    numberOfChildren: 0\n  });\n  const [error, setError] = useState('');\n  const [success, setSuccess] = useState('');\n\n  const userRole = JSON.parse(localStorage.getItem('user') || '{}').role;\n  const isReceptionist = userRole === 'ROLE_RECEPTIONIST';\n  const isManager = userRole === 'ROLE_MANAGER';\n\n  useEffect(() => {\n    fetchData();\n  }, [page]);\n\n  const fetchData = async () => {\n    setLoading(true);\n    try {\n      const [bookingsData, roomsData, guestsData] = await Promise.all([\n        bookingsAPI.getAllBookings(page, rowsPerPage),\n        roomsAPI.getAllRooms(0, 100),\n        guestsAPI.getAllGuests(0, 100)\n      ]);\n      setBookings(bookingsData);\n      setRooms(roomsData);\n      setGuests(guestsData);\n    } catch (err) {\n      setError('Failed to fetch data');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleOpenDialog = (booking?: BookingResponse) => {\n    if (booking) {\n      setEditingBooking(booking);\n      setFormData({\n        guestId: booking.guest.id,\n        roomId: booking.room.id,\n        checkInDate: booking.checkInDate.slice(0, 16),\n        checkOutDate: booking.checkOutDate.slice(0, 16),\n        numberOfAdults: 1,\n        numberOfChildren: 0\n      });\n    } else {\n      setEditingBooking(null);\n      setFormData({\n        guestId: 0,\n        roomId: 0,\n        checkInDate: '',\n        checkOutDate: '',\n        numberOfAdults: 1,\n        numberOfChildren: 0\n      });\n    }\n    setOpenDialog(true);\n    setError('');\n  };\n\n  const handleCloseDialog = () => {\n    setOpenDialog(false);\n    setEditingBooking(null);\n    setError('');\n  };\n\n  const handleSubmit = async () => {\n    if (!formData.guestId || !formData.roomId || !formData.checkInDate || !formData.checkOutDate) {\n      setError('All fields are required');\n      return;\n    }\n\n    try {\n      if (editingBooking) {\n        await bookingsAPI.updateBooking(editingBooking.id, formData);\n        setSuccess('Booking updated successfully');\n      } else {\n        await bookingsAPI.createBooking(formData);\n        setSuccess('Booking created successfully');\n      }\n      fetchData();\n      handleCloseDialog();\n    } catch (err: any) {\n      setError(err.response?.data?.message || 'Operation failed');\n    }\n  };\n\n  const handleDelete = async (id: number) => {\n    if (window.confirm('Are you sure you want to delete this booking?')) {\n      try {\n        await bookingsAPI.deleteBooking(id);\n        setSuccess('Booking deleted successfully');\n        fetchData();\n      } catch (err: any) {\n        setError(err.response?.data?.message || 'Delete failed');\n      }\n    }\n  };\n\n  const handleCheckIn = async (id: number) => {\n    try {\n      await bookingsAPI.checkIn(id);\n      setSuccess('Guest checked in successfully');\n      fetchData();\n    } catch (err: any) {\n      setError(err.response?.data?.message || 'Check-in failed');\n    }\n  };\n\n  const handleCheckOut = async (id: number) => {\n    try {\n      await bookingsAPI.checkOut(id);\n      setSuccess('Guest checked out successfully');\n      fetchData();\n    } catch (err: any) {\n      setError(err.response?.data?.message || 'Check-out failed');\n    }\n  };\n\n  const handleCancel = async (id: number) => {\n    try {\n      await bookingsAPI.cancelBooking(id);\n      setSuccess('Booking cancelled successfully');\n      fetchData();\n    } catch (err: any) {\n      setError(err.response?.data?.message || 'Cancel failed');\n    }\n  };\n\n  const getStatusColor = (status: BookingStatus) => {\n    switch (status) {\n      case BookingStatus.RESERVED:\n        return 'info';\n      case BookingStatus.CHECKED_IN:\n        return 'success';\n      case BookingStatus.CHECKED_OUT:\n        return 'default';\n      case BookingStatus.CANCELLED:\n        return 'error';\n      default:\n        return 'default';\n    }\n  };\n\n  const availableRooms = rooms.filter(room => \n    room.status === 'AVAILABLE' || (editingBooking && room.id === editingBooking.room.id)\n  );\n\n  const handleChangePage = (event: unknown, newPage: number) => {\n    setPage(newPage);\n  };\n\n  const handleChangeRowsPerPage = (event: React.ChangeEvent<HTMLInputElement>) => {\n    setRowsPerPage(parseInt(event.target.value, 10));\n    setPage(0);\n  };\n\n  return (\n    <Box sx={{ p: 3 }}>\n      <Box display=\"flex\" justifyContent=\"space-between\" alignItems=\"center\" mb={3}>\n        <Box>\n          <Typography variant=\"h4\" fontWeight=\"bold\">Bookings Management</Typography>\n          <Typography variant=\"body2\" color=\"textSecondary\" sx={{ mt: 0.5 }}>\n            Manage guest reservations and check-ins\n          </Typography>\n        </Box>\n        <Button\n          variant=\"contained\"\n          startIcon={<Add />}\n          onClick={() => handleOpenDialog()}\n          size=\"large\"\n          sx={{ textTransform: 'none', fontWeight: 600 }}\n        >\n          New Booking\n        </Button>\n      </Box>\n\n      {error && <Alert severity=\"error\" sx={{ mb: 2 }} onClose={() => setError('')}>{error}</Alert>}\n      {success && <Alert severity=\"success\" sx={{ mb: 2 }} onClose={() => setSuccess('')}>{success}</Alert>}\n\n      {loading ? (\n        <Box display=\"flex\" justifyContent=\"center\" py={5}>\n          <CircularProgress />\n        </Box>\n      ) : (\n        <>\n          <TableContainer component={Paper} sx={{ boxShadow: 2 }}>\n            <Table>\n              <TableHead sx={{ backgroundColor: '#f5f5f5' }}>\n                <TableRow>\n                  <TableCell sx={{ fontWeight: 'bold' }}>ID</TableCell>\n                  <TableCell sx={{ fontWeight: 'bold' }}>Guest</TableCell>\n                  <TableCell sx={{ fontWeight: 'bold' }}>Room</TableCell>\n                  <TableCell sx={{ fontWeight: 'bold' }}>Check-in</TableCell>\n                  <TableCell sx={{ fontWeight: 'bold' }}>Check-out</TableCell>\n                  <TableCell sx={{ fontWeight: 'bold' }}>Amount</TableCell>\n                  <TableCell sx={{ fontWeight: 'bold' }}>Status</TableCell>\n                  <TableCell sx={{ fontWeight: 'bold', textAlign: 'center' }}>Actions</TableCell>\n                </TableRow>\n              </TableHead>\n              <TableBody>\n                {bookings.length === 0 ? (\n                  <TableRow>\n                    <TableCell colSpan={8} align=\"center\" sx={{ py: 4 }}>\n                      <Typography color=\"textSecondary\">No bookings found</Typography>\n                    </TableCell>\n                  </TableRow>\n                ) : (\n                  bookings.map((booking) => (\n                    <TableRow key={booking.id} hover>\n                      <TableCell sx={{ fontWeight: 500 }}>{booking.id}</TableCell>\n                      <TableCell>\n                        <Box>\n                          <Typography variant=\"body2\" fontWeight={500}>{booking.guest.name}</Typography>\n                          <Typography variant=\"caption\" color=\"textSecondary\">{booking.guest.email}</Typography>\n                        </Box>\n                      </TableCell>\n                      <TableCell>\n                        <Chip label={booking.room.roomNumber} variant=\"outlined\" size=\"small\" />\n                      </TableCell>\n                      <TableCell>\n                        <Typography variant=\"body2\">\n                          {new Date(booking.checkInDate).toLocaleDateString()}\n                        </Typography>\n                        <Typography variant=\"caption\" color=\"textSecondary\">\n                          {new Date(booking.checkInDate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\n                        </Typography>\n                      </TableCell>\n                      <TableCell>\n                        <Typography variant=\"body2\">\n                          {new Date(booking.checkOutDate).toLocaleDateString()}\n                        </Typography>\n                        <Typography variant=\"caption\" color=\"textSecondary\">\n                          {new Date(booking.checkOutDate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\n                        </Typography>\n                      </TableCell>\n                      <TableCell sx={{ fontWeight: 600 }}>${booking.totalAmount.toFixed(2)}</TableCell>\n                      <TableCell>\n                        <Chip\n                          label={booking.status}\n                          color={getStatusColor(booking.status) as any}\n                          size=\"small\"\n                        />\n                      </TableCell>\n                      <TableCell align=\"center\">\n                        <Tooltip title=\"Edit\">\n                          <IconButton\n                            color=\"primary\"\n                            onClick={() => handleOpenDialog(booking)}\n                            size=\"small\"\n                          >\n                            <Edit fontSize=\"small\" />\n                          </IconButton>\n                        </Tooltip>\n                        <Tooltip title=\"Delete\">\n                          <IconButton\n                            color=\"error\"\n                            onClick={() => handleDelete(booking.id)}\n                            size=\"small\"\n                          >\n                            <Delete fontSize=\"small\" />\n                          </IconButton>\n                        </Tooltip>\n                        {booking.status === BookingStatus.RESERVED && isReceptionist && (\n                          <Tooltip title=\"Check-in\">\n                            <IconButton\n                              color=\"success\"\n                              onClick={() => handleCheckIn(booking.id)}\n                              size=\"small\"\n                            >\n                              <CheckCircle fontSize=\"small\" />\n                            </IconButton>\n                          </Tooltip>\n                        )}\n                        {booking.status === BookingStatus.CHECKED_IN && isReceptionist && (\n                          <Tooltip title=\"Check-out\">\n                            <IconButton\n                              color=\"warning\"\n                              onClick={() => handleCheckOut(booking.id)}\n                              size=\"small\"\n                            >\n                              <LogoutOutlined fontSize=\"small\" />\n                            </IconButton>\n                          </Tooltip>\n                        )}\n                        {booking.status === BookingStatus.RESERVED && (isManager || userRole === 'ROLE_USER') && (\n                          <Tooltip title=\"Cancel\">\n                            <IconButton\n                              color=\"error\"\n                              onClick={() => handleCancel(booking.id)}\n                              size=\"small\"\n                            >\n                              <CancelOutlined fontSize=\"small\" />\n                            </IconButton>\n                          </Tooltip>\n                        )}\n                      </TableCell>\n                    </TableRow>\n                  ))\n                )}\n              </TableBody>\n            </Table>\n          </TableContainer>\n          <TablePagination\n            rowsPerPageOptions={[5, 10, 25]}\n            component=\"div\"\n            count={bookings.length}\n            rowsPerPage={rowsPerPage}\n            page={page}\n            onPageChange={handleChangePage}\n            onRowsPerPageChange={handleChangeRowsPerPage}\n          />\n        </>\n      )}\n\n      <Dialog open={openDialog} onClose={handleCloseDialog} maxWidth=\"md\" fullWidth>\n        <DialogTitle sx={{ fontWeight: 'bold', fontSize: '1.3rem' }}>\n          {editingBooking ? 'Edit Booking' : 'Create New Booking'}\n        </DialogTitle>\n        <DialogContent>\n          <Box sx={{ pt: 2 }}>\n            <Grid container spacing={2}>\n              <Grid item xs={12} md={6}>\n                <FormControl fullWidth required>\n                  <InputLabel>Guest</InputLabel>\n                  <Select\n                    value={formData.guestId}\n                    onChange={(e) => setFormData({ ...formData, guestId: Number(e.target.value) })}\n                    label=\"Guest\"\n                  >\n                    {guests.map((guest) => (\n                      <MenuItem key={guest.id} value={guest.id}>\n                        {guest.name} - {guest.email}\n                      </MenuItem>\n                    ))}\n                  </Select>\n                </FormControl>\n              </Grid>\n              <Grid item xs={12} md={6}>\n                <FormControl fullWidth required>\n                  <InputLabel>Room</InputLabel>\n                  <Select\n                    value={formData.roomId}\n                    onChange={(e) => setFormData({ ...formData, roomId: Number(e.target.value) })}\n                    label=\"Room\"\n                  >\n                    {availableRooms.map((room) => (\n                      <MenuItem key={room.id} value={room.id}>\n                        {room.roomNumber} - {room.roomType} (${room.price}/night)\n                      </MenuItem>\n                    ))}\n                  </Select>\n                </FormControl>\n              </Grid>\n              <Grid item xs={12} md={6}>\n                <TextField\n                  fullWidth\n                  label=\"Check-in Date & Time\"\n                  type=\"datetime-local\"\n                  value={formData.checkInDate}\n                  onChange={(e) => setFormData({ ...formData, checkInDate: e.target.value })}\n                  required\n                  InputLabelProps={{ shrink: true }}\n                />\n              </Grid>\n              <Grid item xs={12} md={6}>\n                <TextField\n                  fullWidth\n                  label=\"Check-out Date & Time\"\n                  type=\"datetime-local\"\n                  value={formData.checkOutDate}\n                  onChange={(e) => setFormData({ ...formData, checkOutDate: e.target.value })}\n                  required\n                  InputLabelProps={{ shrink: true }}\n                />\n              </Grid>\n              <Grid item xs={12} md={6}>\n                <TextField\n                  fullWidth\n                  label=\"Number of Adults\"\n                  type=\"number\"\n                  value={formData.numberOfAdults}\n                  onChange={(e) => setFormData({ ...formData, numberOfAdults: Number(e.target.value) })}\n                  required\n                  inputProps={{ min: 1 }}\n                />\n              </Grid>\n              <Grid item xs={12} md={6}>\n                <TextField\n                  fullWidth\n                  label=\"Number of Children\"\n                  type=\"number\"\n                  value={formData.numberOfChildren}\n                  onChange={(e) => setFormData({ ...formData, numberOfChildren: Number(e.target.value) })}\n                  inputProps={{ min: 0 }}\n                />\n              </Grid>\n            </Grid>\n          </Box>\n        </DialogContent>\n        <DialogActions sx={{ p: 2 }}>\n          <Button onClick={handleCloseDialog}>Cancel</Button>\n          <Button onClick={handleSubmit} variant=\"contained\" sx={{ textTransform: 'none', fontWeight: 600 }}>\n            {editingBooking ? 'Update' : 'Create'}\n          </Button>\n        </DialogActions>\n      </Dialog>\n    </Box>\n  );\n};\n\nexport default Bookings;
