import React, { useState, useEffect } from 'react';
import {
  Box,
  Typography,
  Button,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
  IconButton,
  Alert,
  Grid,
  CircularProgress,
  Tooltip,
  Chip
} from '@mui/material';\nimport {\n  Add,\n  Edit,\n  Delete,\n  Email,\n  Phone,\n  LocationOn\n} from '@mui/icons-material';\nimport { guestsAPI, GuestRequest, GuestResponse } from '../services/api';\n\nconst Guests: React.FC = () => {\n  const [guests, setGuests] = useState<GuestResponse[]>([]);\n  const [openDialog, setOpenDialog] = useState(false);\n  const [editingGuest, setEditingGuest] = useState<GuestResponse | null>(null);\n  const [loading, setLoading] = useState(false);\n  const [formData, setFormData] = useState<GuestRequest>({\n    name: '',\n    email: '',\n    phoneNumber: '',\n    idProofNumber: '',\n    address: ''\n  });\n  const [error, setError] = useState('');\n  const [success, setSuccess] = useState('');\n\n  useEffect(() => {\n    fetchGuests();\n  }, []);\n\n  const fetchGuests = async () => {\n    setLoading(true);\n    try {\n      const data = await guestsAPI.getAllGuests(0, 100);\n      setGuests(data);\n    } catch (err) {\n      setError('Failed to fetch guests');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const validateForm = (): boolean => {\n    if (!formData.name || !formData.email || !formData.phoneNumber || !formData.idProofNumber || !formData.address) {\n      setError('All fields are required');\n      return false;\n    }\n    if (!/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(formData.email)) {\n      setError('Invalid email format');\n      return false;\n    }\n    if (!/^\\d{10}$/.test(formData.phoneNumber)) {\n      setError('Phone number must be 10 digits');\n      return false;\n    }\n    return true;\n  };\n\n  const handleOpenDialog = (guest?: GuestResponse) => {\n    if (guest) {\n      setEditingGuest(guest);\n      setFormData({\n        name: guest.name,\n        email: guest.email,\n        phoneNumber: guest.phoneNumber,\n        idProofNumber: guest.idProofNumber,\n        address: guest.address\n      });\n    } else {\n      setEditingGuest(null);\n      setFormData({\n        name: '',\n        email: '',\n        phoneNumber: '',\n        idProofNumber: '',\n        address: ''\n      });\n    }\n    setOpenDialog(true);\n    setError('');\n  };\n\n  const handleCloseDialog = () => {\n    setOpenDialog(false);\n    setEditingGuest(null);\n    setError('');\n  };\n\n  const handleSubmit = async () => {\n    if (!validateForm()) return;\n\n    try {\n      if (editingGuest) {\n        await guestsAPI.updateGuest(editingGuest.id, formData);\n        setSuccess('Guest updated successfully');\n      } else {\n        await guestsAPI.createGuest(formData);\n        setSuccess('Guest created successfully');\n      }\n      fetchGuests();\n      handleCloseDialog();\n    } catch (err: any) {\n      setError(err.response?.data?.message || 'Operation failed');\n    }\n  };\n\n  const handleDelete = async (id: number, name: string) => {\n    if (window.confirm(`Are you sure you want to delete ${name}?`)) {\n      try {\n        await guestsAPI.deleteGuest(id);\n        setSuccess('Guest deleted successfully');\n        fetchGuests();\n      } catch (err: any) {\n        setError(err.response?.data?.message || 'Delete failed');\n      }\n    }\n  };\n\n  return (\n    <Box sx={{ p: 3 }}>\n      <Box display=\"flex\" justifyContent=\"space-between\" alignItems=\"center\" mb={3}>\n        <Box>\n          <Typography variant=\"h4\" fontWeight=\"bold\">Guests Management</Typography>\n          <Typography variant=\"body2\" color=\"textSecondary\" sx={{ mt: 0.5 }}>\n            Manage guest profiles and information\n          </Typography>\n        </Box>\n        <Button\n          variant=\"contained\"\n          startIcon={<Add />}\n          onClick={() => handleOpenDialog()}\n          size=\"large\"\n          sx={{ textTransform: 'none', fontWeight: 600 }}\n        >\n          Add Guest\n        </Button>\n      </Box>\n\n      {error && <Alert severity=\"error\" sx={{ mb: 2 }} onClose={() => setError('')}>{error}</Alert>}\n      {success && <Alert severity=\"success\" sx={{ mb: 2 }} onClose={() => setSuccess('')}>{success}</Alert>}\n\n      {loading ? (\n        <Box display=\"flex\" justifyContent=\"center\" py={5}>\n          <CircularProgress />\n        </Box>\n      ) : (\n        <TableContainer component={Paper} sx={{ boxShadow: 2 }}>\n          <Table>\n            <TableHead sx={{ backgroundColor: '#f5f5f5' }}>\n              <TableRow>\n                <TableCell sx={{ fontWeight: 'bold' }}>Name</TableCell>\n                <TableCell sx={{ fontWeight: 'bold' }}>Email</TableCell>\n                <TableCell sx={{ fontWeight: 'bold' }}>Phone</TableCell>\n                <TableCell sx={{ fontWeight: 'bold' }}>ID Proof</TableCell>\n                <TableCell sx={{ fontWeight: 'bold' }}>Address</TableCell>\n                <TableCell sx={{ fontWeight: 'bold', textAlign: 'center' }}>Actions</TableCell>\n              </TableRow>\n            </TableHead>\n            <TableBody>\n              {guests.length === 0 ? (\n                <TableRow>\n                  <TableCell colSpan={6} align=\"center\" sx={{ py: 4 }}>\n                    <Typography color=\"textSecondary\">No guests found</Typography>\n                  </TableCell>\n                </TableRow>\n              ) : (\n                guests.map((guest) => (\n                  <TableRow key={guest.id} hover>\n                    <TableCell sx={{ fontWeight: 500 }}>{guest.name}</TableCell>\n                    <TableCell>\n                      <Box display=\"flex\" alignItems=\"center\" gap={1}>\n                        <Email fontSize=\"small\" sx={{ color: '#999' }} />\n                        <Typography variant=\"body2\">{guest.email}</Typography>\n                      </Box>\n                    </TableCell>\n                    <TableCell>\n                      <Box display=\"flex\" alignItems=\"center\" gap={1}>\n                        <Phone fontSize=\"small\" sx={{ color: '#999' }} />\n                        <Typography variant=\"body2\">{guest.phoneNumber}</Typography>\n                      </Box>\n                    </TableCell>\n                    <TableCell>\n                      <Chip label={guest.idProofNumber} variant=\"outlined\" size=\"small\" />\n                    </TableCell>\n                    <TableCell>\n                      <Box display=\"flex\" alignItems=\"center\" gap={1}>\n                        <LocationOn fontSize=\"small\" sx={{ color: '#999' }} />\n                        <Typography variant=\"body2\" noWrap sx={{ maxWidth: 150 }}>\n                          {guest.address}\n                        </Typography>\n                      </Box>\n                    </TableCell>\n                    <TableCell align=\"center\">\n                      <Tooltip title=\"Edit\">\n                        <IconButton\n                          color=\"primary\"\n                          onClick={() => handleOpenDialog(guest)}\n                          size=\"small\"\n                        >\n                          <Edit fontSize=\"small\" />\n                        </IconButton>\n                      </Tooltip>\n                      <Tooltip title=\"Delete\">\n                        <IconButton\n                          color=\"error\"\n                          onClick={() => handleDelete(guest.id, guest.name)}\n                          size=\"small\"\n                        >\n                          <Delete fontSize=\"small\" />\n                        </IconButton>\n                      </Tooltip>\n                    </TableCell>\n                  </TableRow>\n                ))\n              )}\n            </TableBody>\n          </Table>\n        </TableContainer>\n      )}\n\n      <Dialog open={openDialog} onClose={handleCloseDialog} maxWidth=\"md\" fullWidth>\n        <DialogTitle sx={{ fontWeight: 'bold', fontSize: '1.3rem' }}>\n          {editingGuest ? 'Edit Guest' : 'Add New Guest'}\n        </DialogTitle>\n        <DialogContent>\n          <Box sx={{ pt: 2 }}>\n            <Grid container spacing={2}>\n              <Grid item xs={12}>\n                <TextField\n                  fullWidth\n                  label=\"Full Name\"\n                  value={formData.name}\n                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                  required\n                  variant=\"outlined\"\n                />\n              </Grid>\n              <Grid item xs={12} md={6}>\n                <TextField\n                  fullWidth\n                  label=\"Email\"\n                  type=\"email\"\n                  value={formData.email}\n                  onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n                  required\n                  variant=\"outlined\"\n                />\n              </Grid>\n              <Grid item xs={12} md={6}>\n                <TextField\n                  fullWidth\n                  label=\"Phone Number\"\n                  value={formData.phoneNumber}\n                  onChange={(e) => setFormData({ ...formData, phoneNumber: e.target.value })}\n                  required\n                  variant=\"outlined\"\n                  inputProps={{ pattern: '[0-9]{10}' }}\n                  helperText=\"10 digits required\"\n                />\n              </Grid>\n              <Grid item xs={12} md={6}>\n                <TextField\n                  fullWidth\n                  label=\"ID Proof Number\"\n                  value={formData.idProofNumber}\n                  onChange={(e) => setFormData({ ...formData, idProofNumber: e.target.value })}\n                  required\n                  variant=\"outlined\"\n                />\n              </Grid>\n              <Grid item xs={12}>\n                <TextField\n                  fullWidth\n                  label=\"Address\"\n                  multiline\n                  rows={3}\n                  value={formData.address}\n                  onChange={(e) => setFormData({ ...formData, address: e.target.value })}\n                  required\n                  variant=\"outlined\"\n                />\n              </Grid>\n            </Grid>\n          </Box>\n        </DialogContent>\n        <DialogActions sx={{ p: 2 }}>\n          <Button onClick={handleCloseDialog}>Cancel</Button>\n          <Button onClick={handleSubmit} variant=\"contained\" sx={{ textTransform: 'none', fontWeight: 600 }}>\n            {editingGuest ? 'Update' : 'Create'}\n          </Button>\n        </DialogActions>\n      </Dialog>\n    </Box>\n  );\n};\n\nexport default Guests;
